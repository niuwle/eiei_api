NOTES

cd ELLA_HOBS/EIEI_API/
source venv/bin/activate    
uvicorn main:app --reload

./exportgpt.sh 

psql -d eiei_api

PGPASSWORD=3G1RHiXOuV6PHXxdCwfOY97f7vw53fvs psql -h dpg-cml5g4a1hbls73c1rt50-a.oregon-postgres.render.com -U eiei_ps_db_user eiei_ps_db

CREATE DATABASE eieiapi;

CREATE SCHEMA eiei_api;

CREATE USER eiei_user_int WITH PASSWORD 'kLbuS6Pu9ECNHkFfN7ns';

CREATE USER eiei_user_apex WITH PASSWORD 'kLbuS6Pu9ECNHkFfN7ns';

GRANT USAGE ON SCHEMA eiei_api TO eiei_user_int;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA eiei_api TO eiei_user_int;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA eiei_api TO eiei_user_int;
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA eiei_api TO eiei_user_int;

ALTER DEFAULT PRIVILEGES IN SCHEMA eiei_api GRANT ALL PRIVILEGES ON TABLES TO eiei_user_int;
GRANT INSERT, UPDATE, DELETE ON eiei_api.tbl_200_messages TO eiei_user_int;
GRANT SELECT ON eiei_api.tbl_200_messages TO eiei_user_int;

GRANT INSERT, UPDATE, DELETE ON eiei_api.tbl_100_telegram_config TO eiei_user_int;
GRANT SELECT ON eiei_api.tbl_100_telegram_config TO eiei_user_int;

--

GRANT USAGE ON SCHEMA public TO admin_eiei_user2;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO admin_eiei_user2;
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO admin_eiei_user2;

ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO admin_eiei_user2;
GRANT INSERT, UPDATE, DELETE ON tbl_200_messages TO admin_eiei_user2;
GRANT SELECT ON tbl_200_messages TO admin_eiei_user2;

GRANT INSERT, UPDATE, DELETE ON tbl_100_telegram_config TO admin_eiei_user2;
GRANT SELECT ON tbl_100_telegram_config TO admin_eiei_user2;
--
CREATE USER eiei_user_apex WITH PASSWORD 'kLbuS6Pu9ECNHkFfN7ns';

GRANT USAGE ON SCHEMA public TO eiei_user_apex;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO eiei_user_apex;
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO eiei_user_apex;

ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO eiei_user_apex;
GRANT INSERT, UPDATE, DELETE ON tbl_200_messages TO eiei_user_apex;
GRANT SELECT ON tbl_200_messages TO eiei_user_apex;

GRANT INSERT, UPDATE, DELETE ON tbl_100_telegram_config TO eiei_user_apex;
GRANT SELECT ON tbl_100_telegram_config TO eiei_user_apex;


truncate   TABLE eiei_api.tbl_200_messages;
drop    TABLE tbl_200_messages;


CREATE TABLE  tbl_200_messages
  (
     pk_messages  SERIAL PRIMARY KEY,
     channel      VARCHAR(100),
     bot_id       BIGINT NOT NULL,
     user_id      BIGINT,
     chat_id      BIGINT,
     type         VARCHAR(100),
     role         VARCHAR(100),
     content_text VARCHAR(4000),
     file_id      VARCHAR(4000),
     message_date TIMESTAMP,
     update_id    BIGINT,
     message_id   BIGINT, 
     is_processed   VARCHAR(1),
     created_by   VARCHAR(1000),
     created_on   TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
     updated_by   VARCHAR(1000),
     updated_on   TIMESTAMP
  ); 

CREATE TABLE eiei_api.tbl_100_telegram_config (
    pk_bot                SERIAL PRIMARY KEY,
    bot_name              VARCHAR(100),
    bot_short_name        VARCHAR(100),
    bot_description       VARCHAR(4000),
    bot_token             VARCHAR(4000),
    bot_assistant_prompt  VARCHAR(4000),
    bot_pre_prompt        VARCHAR(4000),
    bot_temperature       INTEGER,
    bot_presence_penalty  INTEGER,
    bot_frequency_penalty INTEGER,
    bot_default_reply     VARCHAR(4000),
    created_by            VARCHAR(1000),
    created_on            TIMESTAMP,
    updated_by            VARCHAR(1000),
    updated_on            TIMESTAMP
);



truncate   TABLE tbl_100_telegram_config;

INSERT INTO public.tbl_100_telegram_config (
    pk_bot,
    bot_name,
    bot_short_name,
    bot_description,
    bot_token,
    bot_assistant_prompt,
    bot_pre_prompt,
    bot_temperature,
    bot_presence_penalty,
    bot_frequency_penalty,
    bot_default_reply,
    created_by,
    created_on,
    updated_by,
    updated_on
) VALUES (
    0, -- pk_bot
    'Sample Bot', -- bot_name
    'SampleBot', -- bot_short_name
    'This is a description of Sample Bot.', -- bot_description
    '6922050326:AAEGdw2gG5zm6EWwSobBl0KvIykl_l9uMHw', -- bot_token (replace with actual token)
    'Hello! How can I assist you today?', -- bot_assistant_prompt
    'Please provide detailed information so I can assist you better.', -- bot_pre_prompt
    0.7, -- bot_temperature (0 to 1, adjust as needed)
    0, -- bot_presence_penalty (0 to 1, adjust as needed)
    0, -- bot_frequency_penalty (0 to 1, adjust as needed)
    'I am sorry, I do not understand.', -- bot_default_reply
    'admin', -- created_by
    CURRENT_TIMESTAMP, -- created_on
    'admin', -- updated_by
    CURRENT_TIMESTAMP -- updated_on
);


curl -X POST "http://localhost:8000/receive-message" \
     -H "Content-Type: application/json" \
     -d '{"chat_id": 12345, "user_id": 67890, "bot_id": 13579, "message_text": "remember my name?", "message_id": 101112, "channel": "TestChannel", "channel": "TestChannel", "update_id": 131415}'


curl -X POST "https://eiei-api.onrender.com/receive-message" \
     -H "Content-Type: application/json" \
     -d '{"chat_id": 12345, "user_id": 67890, "bot_id": 13579, "message_text": "remember my name?", "message_id": 101112, "channel": "TestChannel", "channel": "TestChannel", "update_id": 131415}'



Please check that this workflow is true in all sentences to the following app, if not please just rewrite the code needed to accomodate
Example Workflow:
Receive and save the message in the database with is_processed='N'
after that it Launchs the process_queue process
the process_queue grabd the current timestamp and then  Wait for 3 seconds , then grabs the latest message form the user and checks if the message is older than the timestamp grabbed before (meaning no new messages arrived in those 3 sec) then proceeds with the process if not then it quits (a new messasge arrived and that new instance will handle to process all previous messages)
proceed with the processing of the current message.
First marks them with is_processed='P' for pending 
 makes the needfull to call the ai completition function stuff, 
then it sends the response of the ai  back to the user via telegram
After processing, mark the message as is_processed='Y'



----------
AWS:
https://signin.aws.amazon.com/signin?redirect_uri=https%3A%2F%2Fus-east-1.console.aws.amazon.com%2Fec2%2Fhome%3Fregion%3Dus-east-1%26state%3DhashArgs%2523LaunchInstances%253A%26isauthcode%3Dtrue&client_id=arn%3Aaws%3Aiam%3A%3A015428540659%3Auser%2Fec2&forceMobileApp=0&code_challenge=F512pliZ5aHCWy-1b2C7FzLh7g6sXHNTyJq1QhK7Ev8&code_challenge_method=SHA-256
pabluss89+newaws@gmail.com
gQss4wKFLMXUWBn!US2ZA!oJ*oBmYdRF

---
postgres:

eiei_api_admin
3G1RHiXOuV6PHXxdCwfOY97f7vw53fvs

psql -h eieiapi.cpua44ciw909.us-east-1.rds.amazonaws.com -U eiei_api_admin -d postgres

---
CMD

ssh -i /Users/pablolebrero/ELLA_HOBS/EIEI_API/bot_pair.pem ec2-user@ec2-54-227-154-67.compute-1.amazonaws.com


cd eiei_api/
source venv/bin/activate    
uvicorn main:app --reload


scp -i /Users/pablolebrero/ELLA_HOBS/EIEI_API/bot_pair.pem /Users/pablolebrero/ELLA_HOBS/EIEI_API/.env ec2-user@ec2-54-227-154-67.compute-1.amazonaws.com:/home/ec2-user/eiei_api/eiei_api

----------

oracle apex
workspace: eiei_api

admin
wiA8%o*gDC37KRmo*HB&

admin-home
https://g64d3821c385420-krps7pyzpvlqmoxx.adb.eu-madrid-1.oraclecloudapps.com/ords/r/apex/workspace/home?session=103902384567198

app-home
https://g64d3821c385420-krps7pyzpvlqmoxx.adb.eu-madrid-1.oraclecloudapps.com/ords/r/eiei_api/bot-manager101/

stuff:
Connect postgres
https://blogs.oracle.com/apex/post/connecting-your-apex-apps-to-non-oracle-databases-with-oracle-autonomous-database

POSTGRES_USER
postgres_user
ZkBmbNPSFC9Xyuk5woeW

BEGIN
    DBMS_CLOUD_ADMIN.CREATE_DATABASE_LINK(
        db_link_name => 'POSTGRES_2_DBLINK',
        hostname => 'dpg-cml5g4a1hbls73c1rt50-a.oregon-postgres.render.com',
        port => '5432',
        service_name => 'eiei_ps_db',
        credential_name => 'POSTGRES_2',
        gateway_params => JSON_OBJECT('db_type' VALUE 'POSTGRES'),
        ssl_server_cert_dn => NULL
    );
END;
/

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



---
https://api.telegram.org/bot<YourBotToken>/setWebhook?url=<YourWebhookURL>



https://eieiapi.cpua44ciw909.us-east-1.rds.amazonaws.com/


curl -X POST "https://eiei-api.onrender.com/receive-message" \
     -H "Content-Type: application/json" \
     -d '{"chat_id": 12345, "user_id": 67890, "bot_id": 13579, "message_text": "Hi iM PABLO", "message_id": 101112, "channel": "TestChannel", "channel": "TestChannel", "update_id": 131415}'

https://ec2-54-227-154-67.compute-1.amazonaws.com/


https://api.telegram.org/bot6922050326:AAEGdw2gG5zm6EWwSobBl0KvIykl_l9uMHw/setWebhook?url=https://eiei-api.onrender.com/telegram-webhook/test/SampleBot


curl -X POST "http://localhost:8000/telegram-webhook/test/SampleBot" \
     -H "Content-Type: application/json" \
     -d '{"update_id":103499615,"message":{"message_id":403,"from":{"id":6449898496,"is_bot":false,"first_name":"P","language_code":"en"},"chat":{"id":6449898496,"first_name":"P","type":"private"},"date":1706204019,"text":"test"}}'


--test text
curl -X POST "https://eiei-api.onrender.com/telegram-webhook/test/SampleBot" \
     -H "Content-Type: application/json" \
     -d '{"update_id":103499615,"message":{"message_id":403,"from":{"id":6449898496,"is_bot":false,"first_name":"P","language_code":"en"},"chat":{"id":6449898496,"first_name":"P","type":"private"},"date":1706204019,"text":"test"}}'

--test audio
curl -X POST "http://localhost:8000/telegram-webhook/test/SampleBot" \
     -H "Content-Type: application/json" \
     -d '{"update_id":103499669,"message":{"message_id":507,"from":{"id":6449898496,"is_bot":false,"first_name":"P","language_code":"en"},"chat":{"id":6449898496,"first_name":"P","type":"private"},"date":1706283344,"voice":{"duration":3,"mime_type":"audio/ogg","file_id":"AwACAgEAAxkBAAICAAFltirme4Ej_A_evrBnJ4LSQsUp-AACWwQAAm0IoEW-PMcrQylUxzQE","file_unique_id":"AgADWwQAAm0IoEU","file_size":7336}}}'



Test json from bot
{
  "update_id": 103499615,
  "message": {
    "message_id": 403,
    "from": {
      "id": 6449898496,
      "is_bot": false,
      "first_name": "P",
      "language_code": "en"
    },
    "chat": {
      "id": 6449898496,
      "first_name": "P",
      "type": "private"
    },
    "date": 1706204019,
    "text": "test"
  }
}